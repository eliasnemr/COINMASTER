<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link href="css/styles.css" rel="stylesheet">
    <script src="js/minima.js"></script>
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.7/jsrender.min.js"></script>
    <title>COIN MASTER</title>
</head>
<body>
<script id="templateCoins" type="text/x-jsrender">
    <div id="templCoins" class="list-group">
        {{for coins}}
        <span class="input-group-text" id="basic-addon1"><input id="{{:coinid}}" name="checkbox" class="mr-1" type="checkbox">Coin #{{:index}}</span>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            {{:coinid}}
        <span name="inp-amount{{:index}}" class="badge badge-primary badge-pill">{{:amount}}</span>
        </a>
        {{/for}}
      </div>
</script>
<script id="templateInputs" type="text/x-jsrender">
    <div id="templInputs" class="list-group">
        {{for inputs}}
        <span class="input-group-text" id="basic-addon1">Input #{{:index}}</span>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            {{:coinid}}
        <span class="badge badge-primary badge-pill">{{:amount}}</span>
        </a>
        {{/for}}
    </div>        
</script>
<script>

    var coinArr = []; // holds all coins of token
    var templ = $.templates('#templateCoins');

$(document).ready(function(){

    function getCoins(tokenId) {

        if($("#templCoins").length > 0) {
            $("#templCoins").remove();
            coinArr = [];
        }

        Minima.cmd("coinsimple "+tokenId, 
        function(res){
            
            res.response.coins.forEach(function(coin, i) {
                
                if(coin.coin.amount > 0) {
                    
                    coinArr.push({index: i, coinid: coin.coin.coinid, amount: coin.coin.amount});

                }
            });

            var html = templ.render({coins: coinArr});

            $("#jumbo form button").before(html);
        });
    }

    Minima.init(function(msg) {
        if(msg.event == 'connected'){
            var tokenId = Minima.form.getParams("token");
            getCoins(tokenId);

        } else if(msg.event == 'newbalance') {
            var tokenId = Minima.form.getParams("token");
            $('.toast').toast();
            
            getCoins(tokenId);
        } else if(msg.event == 'miningstart') {
            $('.toast').toast('show');
        } else if(msg.event == 'miningstop') {
            $('.toast').toast('show');
        }
    });
});
</script>

    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="./index.html">
        <img src="./assets/coin.svg" width="30" height="30" alt="" loading="lazy">
        </a>
        <h5>Coin Master</h5>
    </nav>

    <div id="info" class="alert alert-light" role="alert">
        Select the coins you would like to aggregate below...
    </div>

    <div style="position: relative;">
        <div class="toast" id="toast-start" data-autohide="false" style="position: absolute; top: 0; right: 0; z-index:10;">
            <div class="toast-header">
            <img src="./assets/coin.svg" class="rounded mr-2" alt="coinmaster" style="width: 25px; height: 20px;">
            <strong class="mr-auto">Minima</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="toast-body">
            Mining started..
            </div>
        </div>
    </div>
    <div style="position: relative;">
        <div class="toast" id="toast-stop" data-autohide="false" style="position: absolute; top: 0; right: 0;">
            <div class="toast-header">
            <img src="./assets/coin.svg" class="rounded mr-2" alt="coinmaster" style="width: 25px; height: 20px;">
            <strong class="mr-auto">Minima</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="toast-body">
            Mining stopped..
            </div>
        </div>
    </div>

    <div class="container pt-5">

        <div id="jumbo" class="jumbotron mb-2">
            <h2>All available coins</h2>
            <form action="" class="main-form needs-validation" novalidate required>   
            <button id="aggrBtn" type="button" class="btn btn-primary mt-2">Aggregate</button>
            </form>
        </div>

        <div id="arrow" style="display:none !important;" class="d-flex justify-content-center">
            <svg width="5em" height="2.5em" viewBox="0 0 16 16" class="bi bi-arrow-down-circle" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708L7.5 10.293V4.5A.5.5 0 0 1 8 4z"/>
            </svg>
        </div>

    <section id="postForm"> 
        <form action="posted.html" method="POST" enctype="multipart/form-data">
        <div style="display:none;" id="jumboOutputs" class="jumbotron mt-2">
            <h2>Your output</h2>
            
                <span class="input-group-text" id="basic-addon1">Output #0</span>
                <div class="input-group input-group-sm mb-3">
                    
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">@</span>
                    </div>
                    <input 
                    id="addr"
                    name="addr"
                    type="text" 
                    class="form-control" aria-label="output address" 
                    aria-describedby="inputGroup-sizing-sm" readonly>

                    <input 
                    id="amnt"
                    name="amnt" 
                    type="number"
                    class="form-control" aria-label="output amount" 
                    aria-describedby="inputGroup-sizing-sm" readonly>
                    
                </div>
        </div>
        <div class="row">
            <div class="col">
                <!-- <button id="postBtn" onclick="createTxn()" style="display: none;" type="submit" class="btn btn-primary btn-block">Post</button> -->
                <button id="postBtn" style="display: none;" type="submit" class="btn btn-primary btn-block">Post</button>
            </div>
        </div>
        </form>
    </section>

    </div>

    

    <script>

        var btn = document.getElementById("aggrBtn");
        var templInputs = $.templates('#templateInputs');
        var atleast = 0;

        btn.addEventListener("click", function(event){
            var form = document.forms[0];
            var selectElement = form.querySelectorAll('input[name="checkbox"]');
            var temp = coinArr;

            selectElement.forEach((ele, i) => {
                // if checkbox is checked
                if(!ele.checked) {
                    for(var i = 0; i < temp.length; i++) {
                        if(ele.id == temp[i].coinid) {
                            temp.splice(i, 1);
                        }
                    }
                } else if(ele.checked) {
                    atleast = 1;
                }

            });
                
            // there's atleast 1 chosen input.. 
            if(atleast != 0) {
                $('#jumbo form button').css("display", "none");
                $('#jumbo form').css("display", "none");
    
                var html = templInputs.render({inputs: temp});
    
                $('#jumbo').append(html);
    
                $('#jumbo h2').text("Your inputs");
    
                $('#info').text("This is your aggregate transaction, post it to aggregate your coin(s)...");
    
                $('#jumboOutputs').css('display', 'block');
    
                $('#arrow').css('display', 'block');
                
                $('#postBtn').css('display', 'block');

                Minima.cmd('newaddress', function(res){
                   document.getElementById('addr').value = res.response.address.miniaddress;
                });

                var total = 0;
                temp.forEach(coin => {
                    total = total + parseFloat(coin.amount);
                    document.getElementById('amnt').value = total;
                });

            } else {
                
            }
        });   
    </script>
    <script>
        

        async function postTransaction(address, amount, tokenid, coinid) {
            console.log("posting...");
            // id
            const id = Math.floor(Math.random()*1000000000);
            const txn = {
                id: id,
                output: {
                    address: address,
                    amount: amount,
                    tokenid: tokenid
                },
                inputs: {
                    coinid: coinid,
                }
            };

            const xhr = new XMLHttpRequest();
            var urlEncodedData = encodeURIComponent(JSON.stringify(txn));
            // Define what happens on successful data submission
            xhr.addEventListener( 'load', function(event) {
                alert( 'Yeah! Data sent and response loaded.' );
            } );

            // Define what happens in case of error
            xhr.addEventListener( 'error', function(event) {
                alert( 'Oops! Something went wrong.' );
            } );

            // Set up our request
            xhr.open( 'POST', Minima.webhost+"posted.html/params" );

            // Add the required HTTP header for form data POST requests
            xhr.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );

            // Finally, send our data.
            xhr.send( urlEncodedData );

        }
        var form = document.querySelector('#postForm form');

        form.addEventListener('submit', event => {
            console.log("Submitted!");
            event.preventDefault();
            const addr = event.currentTarget.querySelector('#addr').value;
            const amnt = event.currentTarget.querySelector('#amnt').value;
            const tokenid = Minima.form.getParams('token');
            const temp = coinArr;
            
            postTransaction(addr, amnt, tokenid, temp);


        });

        var inp = coinArr;

        var form = document.forms[0];
        var selectElement = form.querySelectorAll('input[name="out-address"]');
        
        function createTxn() {
            // create random id
            var id = Math.floor(Math.random()*1000000000);
            var inputs = "";
            inp.forEach((input, i) => {
                inputs+="txninput "+id+" "+input.coinid+" "+i+";";
            });
            //var output = "txnoutput "+id+" "+"5"+" "+"MxI35TSP3WDLSANNBJW4T7NBID4RDZHSAU"+" "+out.tokenid+" "+out.position+";";
            var tokenid = Minima.form.getParams("token");

            var addr = document.getElementById('output-0').value;
            var amnt = document.getElementById('output-1').value;

            var txn = "txncreate "+id+";"
                       +inputs+ // add inputs
                       "txnoutput "+id+" "+amnt+" "+addr+" "+tokenid+" "+"0"+";"+ // add output
                       "txnsignauto "+id+";" // auto sign
                       +"txnpost "+id+";"+ // post it
                       "txndelete "+id; // delete it

            Minima.cmd(txn, function(res) {
                console.log(res);

                if(Minima.util.checkAllResponses(res)) {
                    $('#txn-success').modal({backdrop:false});
                }
            });
        }
    </script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</body>
</html>