<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link href="css/styles.css" rel="stylesheet">
    <link href="js/Toast/src/css/toast.css" rel="stylesheet">
    <script src="js/minima.js"></script>
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.7/jsrender.min.js"></script>
    <title>COIN MASTER</title>
</head>
<body>
    <script id="templateTokens" type="text/x-jsrender">
        <div id="templTokens">
            <ul class="list-group-item">
                {{for tokens}}
                <li class="list-group-item token">
                    <div class="row h-100" onclick='getToken("{{:tokenid}}")'>
                        <div class="col-2 my-auto">
                            {{if icon}}
                            {{:icon}}
                            <img src="{{:icon}}" class="img-fluid icon">
                            {{else}}
                            <img src="assets/icon.png" class="img-fluid icon">
                            {{/if}}
                        </div>
                        <div class="col-md-5 my-auto name">
                            {{:token}}
                        </div>
                        <div class="col-md-3 my-auto conf">
                            {{:confirmed}}
                        </div>
                        <div class="col-md-2 my-auto coin">
                            {{if coin>1}}
                            {{:coin + " coins"}}
                            {{else}} 
                            {{:coin + " coin"}}
                            {{/if}}
                        </div>
                    </div>
                </li>
                {{/for}}
            </ul>
            
        
        </div>

    </script>

    <script>
        function setTokenAmount() {
            Minima.cmd('balance', function(res){
                
                var total = res.response.balance.length;
                if(total > 1) {
                    document.getElementById('token-amount').innerText = "You currently have "+total+" tokens.";
                } else if(total == 1) {
                    document.getElementById('token-amount').innerText = "You currently have "+total+" token.";
                } else {
                    document.getElementById('token-amount').innerText = "Loading...";
                }


            });
        }
        function setTotalTokens() {
            Minima.cmd('balance', function(res) {
                var totalT = 0;
                var totalMini = 0;
                var yourMini = 0;
                res.response.balance.forEach(token => {
                    if(token.tokenid !== '0x00') {
                        totalT = totalT + parseFloat(token.total);
                    } else if(token.tokenid == '0x00') {
                        totalMini = parseInt(token.total);
                        yourMini = parseInt(token.confirmed);
                    }
                });

                document.getElementById('minima-total').innerText = "There is a cap of "+totalMini +" MINI tokens and you own "+yourMini+" MINI.";

            });
        }
        function getToken(id) {
            window.location.href="./aggregate.html?token="+id;
        }

        var tmpl = $.templates('#templateTokens');
        var tokens = [];
        // get tokens of user
        async function setBalance(tmpl, tokens) {
            var tokens;
            var coin;
            await new Promise((resolve, reject) => {

                if($('#templTokens').length > 0){
                    $('#templTokens').remove();
                    tokens = [];
                }

                Minima.cmd("balance", function(res){
                    res.response.balance.forEach(function(tkn){

                        new Promise((resolve, reject) => {
                            
                            // return amnt of coins
                            Minima.cmd("coinsimple "+tkn.tokenid, function(resp){ 
                                coin = resp.response.coins.length;
                                resolve(coin);

                            });


                        }).then(res => {
                            
                            tokens
                            .push({
                                coinid: tkn.coinid,
                                confirmed: tkn.confirmed,
                                description: tkn.description,
                                icon: tkn.icon,
                                mempool: tkn.mempool,
                                proof: tkn.proof,
                                scale: tkn.scale,
                                script: tkn.script,
                                sendable: tkn.sendable,
                                token: tkn.token,
                                tokenid: tkn.tokenid,
                                total: tkn.total,
                                totalamount: tkn.totalamount,
                                unconfirmed: tkn.unconfirmed,
                                coin: res
                            });
                        });
                    });
                    setTimeout(()=> {
                        resolve(tokens);
                    }, 100);
                });

                }).then(tokens => {
                    
                    var html = tmpl.render({tokens: tokens});
                    $('#jumbo h2').after(html);
                
                });
        }
        $(document).ready(function(){
            Minima.init(function(msg) {
                if(msg.event == 'connected'){
                    setBalance(tmpl, tokens); // get tokens of user
                    setTokenAmount();
                    setTotalTokens()

                } else if(msg.event == 'newbalance') {
                    setBalance(tmpl, tokens);    
                    setTokenAmount();
                    setTotalTokens()
                } else if(msg.event == "miningstop") {
                    $.snack("info", "Mining stopping..", "4000");
                } else if(msg.event == 'miningstart') {
                    $.snack("info", "Mining starting..", "4000");
                }
            });
        });
    </script>

    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
          <img src="./assets/coin.svg" width="30" height="30" alt="" loading="lazy">
        </a>
        <h5>Coin Master</h5>
    </nav>

    <div class="alert alert-light" role="alert">
        Choose a token to view its coins...
    </div>


    <div class="container pt-5">

        <div id="jumbo" class="jumbotron"><h2>Your Tokens</h2></div>

    </div>

    <div class="container pt-5">

        <div id="jumbo2" class="jumbotron">
            <h2>Stats</h2>
        
            <div class="row d-flex justify-content-around">
                <div class="card" style="width: 18rem;">
                    <img src="./assets/tokens.svg" class="card-img-top" alt="tokens">
                    <div class="card-body">
                      <h5 class="card-title">Tokens</h5>
                      <p class="card-text" id="token-amount"></p>
                    </div>
                  </div>
                  <div class="card" style="width: 18rem;">
                    <img src="./assets/icon.png" class="card-img-top" alt="minima">
                    <div class="card-body">
                      <h5 class="card-title">Minima Token</h5>
                      <p class="card-text" id="minima-total"></p>
                    </div>
                  </div>
                  
            
            </div>

        </div>

    </div>


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="js/Toast/src/js/toast.js"></script>

</body>
</html>